#!/usr/bin/env bash

set -euo pipefail

# –¶–≤–µ—Ç–∞ –∏ —Å—Ç–∏–ª–∏
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RESET='\033[0m'

# –≠–º–æ–¥–∑–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
WIFI_ICON="üì∂"
BT_ICON="uetooth"
ALL_ICON="üîå"
HELP_ICON="‚ùì"
OK_ICON="‚úÖ"
ERR_ICON="‚ùå"

show_help() {
    cat <<EOF

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ —á–µ—Ä–µ–∑ rfkill

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    $0 <block|unblock> <wifi|bluetooth|all>

–ö–æ–º–∞–Ω–¥—ã:
    block                               - –æ—Ç–∫–ª—é—á–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    unblock                            - –≤–∫–ª—é—á–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
    wifi                                - Wi-Fi
    bluetooth                           - Bluetooth
    all                                 - –í—Å–µ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

–ü—Ä–∏–º–µ—Ä—ã:
    $0 block wifi
    $0 unblock bluetooth
    $0 block all

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
  –î–ª—è –ø—Ä–æ–≤–æ–¥–Ω–æ–≥–æ LAN –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ \`ip\` –∏–ª–∏ NetworkManager ‚Äî rfkill –µ–≥–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç.

EOF
}

log() {
    local level="$1"; shift
    case "$level" in
        ok)    echo -e "${OK_ICON} ${GREEN}$*${RESET}" ;;
        err)   echo -e "${ERR_ICON} ${RED}$*${RESET}" >&2 ;;
        info)  echo -e "${HELP_ICON} ${BLUE}$*${RESET}" ;;
        warn)  echo -e "${ERR_ICON} ${YELLOW}$*${RESET}" >&2 ;;
    esac
}

normalize_device() {
    case "$1" in
        wifi) echo "wifi" ;;
        bluetooth|bt) echo "bluetooth" ;;
        all) echo "all" ;;
        *) echo "invalid" ;;
    esac
}

main() {
    if [ "$#" -eq 0 ] || [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        show_help
        exit 0
    fi

    if [ "$#" -ne 2 ]; then
        log err "–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤."
        log info "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 --help"
        exit 1
    fi

    local method="$1"
    local device_raw="$2"
    local device
    device="$(normalize_device "$device_raw")"

    if [ "$device" = "invalid" ]; then
        log err "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: '$device_raw'"
        log info "–î–æ–ø—É—Å—Ç–∏–º—ã–µ: wifi, wlan, bluetooth, bt, all"
        exit 1
    fi

    if ! command -v rfkill >/dev/null 2>&1; then
        log err "–ö–æ–º–∞–Ω–¥–∞ 'rfkill' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç 'rfkill' –∏–ª–∏ 'linux-firmware'."
        exit 1
    fi

    case "$method" in
        block)
            log info "–û—Ç–∫–ª—é—á–∞—é ${device}..."
            case "$device" in
                wifi)       rfkill block wifi ;;
                bluetooth)  rfkill block bluetooth ;;
                all)        rfkill block all ;;
            esac
            log ok "${device^} —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω."
            ;;
        unblock)
            log info "–í–∫–ª—é—á–∞—é ${device}..."
            case "$device" in
                wifi)       rfkill unblock wifi ;;
                bluetooth)  rfkill unblock bluetooth ;;
                all)        rfkill unblock all ;;
            esac
            log ok "${device^} —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á—ë–Ω."
            ;;
        *)
            log err "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥: '$method'"
            log info "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: block, unblock"
            exit 1
            ;;
    esac
}

main "$@"