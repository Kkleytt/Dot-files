#!/bin/bash
# /* ---- üí´ https://github.com/JaKooLit üí´ ---- */  ##
# Script for Monitor backlights (if supported) using brightnessctl

iDIR="$HOME/.config/swaync/icons"
notification_timeout=1000
send_notify=false

# –ü—Ä–∞–≤–∏–ª–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ (–ö–æ–ª-–≤–æ —à–∞–≥–æ–≤ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏)
BRI_STEPS=20
SEND_NOTIFY=false
BRI_STEP_SIZE=$((100 / $BRI_STEPS))


# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
send_notification() {
    local brightness=$1
    local icon_path=$2

    notify-send -e \
        -h string:x-canonical-private-synchronous:brightness_notif \
        -h int:value:"$brightness" \
        -u low \
        -i "$icon_path" \
        "Screen" "Brightness: ${brightness}%"
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏
get_brightness() {
    brightnessctl -m | cut -d, -f4 | tr -d '%'
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
get_icon_path() {
    local brightness=$1
    local level=$(( (brightness + 19) / 20 * 20 ))  # Round up to next 20
    if (( level > 100 )); then
        level=100
    fi
    echo "$iDIR/brightness-${level}.png"
}

# –§—É–Ω–∫—Ü–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
round_brightness() {
    local brightness=$1
    local direction=$2 # "up" –∏–ª–∏ "down"

    if [[ "$direction" == "up" ]]; then
        # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –¥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ STEP_SIZE
        echo $(( ((brightness + BRI_STEP_SIZE - 1) / BRI_STEP_SIZE) * BRI_STEP_SIZE ))
    else
        # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–Ω–∏–∑ –¥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ STEP_SIZE
        echo $(( (brightness / BRI_STEP_SIZE) * BRI_STEP_SIZE ))
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏
change_brightness() {
    local direction="$1"
    local current new icon

    current=$(get_brightness)

    if (( current % BRI_STEP_SIZE == 0 )); then
        if [[ $direction == "up" ]]; then
            new=$(( current + BRI_STEP_SIZE ))
        else
            new=$(( current - BRI_STEP_SIZE ))
        fi
    else
        new=$( round_brightness "$current" "$direction" )
    fi



    

    # Clamp between 5 and 100
    (( new < 5 )) && new=5
    (( new > 100 )) && new=100

    brightnessctl set "${new}%"

    icon=$(get_icon_path "$new")

    if [ $send_notify == "true" ]; then
        send_notification "$new" "$icon"
    fi
}


# Main
case "$1" in
    "--get")
        get_brightness
        ;;
    "--inc")
        change_brightness "up"
        ;;
    "--dec")
        change_brightness "down"
        ;;
    *)
        get_brightness
        ;;
esac
